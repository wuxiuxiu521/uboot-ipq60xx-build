name: 编译 AX1800Pro-Uboot

on:
  repository_dispatch:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v2

    - name: 初始化环境
      run: |
        sudo apt-get update
        sudo apt-get install -y git python2.7 build-essential device-tree-compiler
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python
        python --version

    - name: 下载源码并切换到正确分支
      run: |
        git clone https://github.com/wuxiuxiu521/uboot-ipq60xx-build -b master uboot
        cd uboot

    - name: 编译 UBoot
      working-directory: ./uboot
      run: |
        ./build.sh

    - name: 查看编译目录内容
      working-directory: ./uboot
      run: |
        # find . -name "u-boot.*"
        find . -name "u-boot.bin"
        find . -name "u-boot.mbn"
        ll

    # 动态生成当前日期时间作为 Release 的标签和名称
    - name: 设置 Release 标签和名称
      id: set_tag_name
      run: |
        TAG_NAME=$(date +"%Y.%m.%d-%H.%M")  # 修改为合法的 Git 标签格式
        echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
        echo "RELEASE_NAME=AX1800Pro-Uboot $TAG_NAME" >> $GITHUB_ENV

    # 1. 创建 Release
    - name: 创建 Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.TAG_NAME }}           # 使用动态生成的标签名称
        release_name: ${{ env.RELEASE_NAME }}   # 使用动态生成的 Release 名称
        draft: false                             # 如果你希望手动发布，将其改为 true
        prerelease: false

    # 2. 上传编译好的文件到 Release
    - name: 上传固件到 Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        # asset_path: ./u-boot-2016/u-boot.bin
        asset_path: ./u-boot.bin
        asset_name: u-boot.bin
        asset_content_type: application/octet-stream

    # - name: 上传 MBN 文件到 Release
    #   uses: actions/upload-release-asset@v1
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #   with:
    #     upload_url: ${{ steps.create_release.outputs.upload_url }}
    #     asset_path: ./u-boot.mbn
    #     asset_name: u-boot.mbn
    #     asset_content_type: application/octet-stream
