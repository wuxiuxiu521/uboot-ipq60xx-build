name: 编译 AX1800Pro-Uboot

on:
  repository_dispatch:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v2

    - name: 初始化环境
      run: |
        sudo apt-get update
        sudo apt-get install -y git python2.7 build-essential device-tree-compiler
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python
        python --version

    - name: 下载源码并切换到正确分支
      run: |
        git clone https://github.com/wuxiuxiu521/uboot-ipq60xx-build -b master uboot
        cd uboot

    - name: 编译 UBoot
      working-directory: ./uboot
      run: |
        ./build.sh

    - name: 查看编译目录内容
      working-directory: ./uboot
      run: |
        find . -name "u-boot.*"

    # 1. 创建 Release（如果已有 Release，可以省略此步骤）
    - name: 创建 Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: "v1.0.0"      # 修改成你希望的版本号
        release_name: "AX1800Pro-Uboot v1.0.0"
        draft: false             # 如果你希望手动发布，将其改为 true
        prerelease: false

    # 2. 上传编译好的文件到 Release
    - name: 上传固件到 Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./u-boot-2016/u-boot.bin
        asset_name: u-boot.bin
        asset_content_type: application/octet-stream

    - name: 上传 MBN 文件到 Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./u-boot.mbn
        asset_name: u-boot.mbn
        asset_content_type: application/octet-stream
